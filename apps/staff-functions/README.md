# Overview

This folder contains Firebase Cloud Functions for the Recidiviz staff project, a data platform aimed at criminal justice reform. The functions are written in TypeScript and are structured to handle various tasks as noted below. To see possible use cases, click [here](https://firebase.google.com/docs/functions/use-cases).

## About Creating New Functions

### Firebase Functions Documentation

To create a new firebase function for a new environment (1️⃣) or in an already initialized environment(2️⃣), please read the following documentation:

- [Write function in TypeScript](https://firebase.google.com/docs/functions/typescript) 1️⃣2️⃣
- [Configuring Environments](https://firebase.google.com/docs/functions/config-env?gen=1st) 1️⃣
- [Organizing Firebase Functions (aka where to put a new function)](https://firebase.google.com/docs/functions/organize-functions?gen=1st) 1️⃣
- [Write and View Logs](https://firebase.google.com/docs/functions/writing-and-viewing-logs?gen=1st) 1️⃣2️⃣

### Creating New Functions

#### Getting Started

1. Navigate to the `src/index.ts` add the function following the example below:

   ⚠️ NOTE: Prefix the function name when exporting from `index.ts` with `test` to prevent logs from being shown in the on call console as this new function is being tested.

   `index.ts`

   ```typescript
   exports.someFunction = ...

   exports.someOtherFunction = ...

   exports.testSomeNewFunction = ...
   ```

#### Development

1. Add logs throughout the function, so they are reported in the console. (Look at the documentation relevant to the use case for this function to see the logging conventions.)
1. Run the command `nx lint staff-functions` to view the lint errors and warnings or `nx lint staff-functions --fix` to fix the lint errors and warnings. Run `nx typecheck staff-functions` to view Typescript errors.
1. Run `nx dev staff-functions` to compile the Typescript source and run the functions in the Firebase emulator.

#### Testing and Deploying

> [!WARNING]  
> Added May 9, 2025 by @danielsmc: the deploy process for functions is currently broken. I added
> I added https://github.com/Recidiviz/pulse-dashboards/issues/8403 to fix this, but for now here are the steps that worked for me:
>
> - `nx build staff-functions -c production`
> - In `dist/apps/staff-functions`:
>   - `cp ../../../.yarnrc.yml .`
>   - `yarn`
>   - `rm -r node_modules .yarn`
> - Back at root: `firebase deploy --only functions --config firebase.json --project production-backend`

1. Use Nx commands to deploy these functions to Firebase. There are separate configurations with corresponding dotenv viles that will build and deploy the functions source for staging or production; run `nx deploy staff-functions -c staging` or `nx deploy staff-functions -c production` accordingly.
1. Click the link returned in the terminal after a successful upload of the function.
1. Click on "Functions" to see the list of functions. The new function should be in the list.
1. Click on the three dots in the row of the function.

   1. Click on "View Logs" to see the logs generated by the function.
   2. There MAY OR MAY NOT be an option to view the function in a different GCP application. If so, attempt a force run of the new function.

1. To officially deploy the function with enabled logs, remove the _test_ prefix.

#### Documentation

Use this template to document the new function in the README:

> This function is scheduled to run every Friday at 11:59 PM PDT. It exports specified Firestore collections to a Google Cloud Storage bucket.
>
> - Trigger: _How is this triggered?_
> - Environment Variables:
>   - `SOME_ENV_VAR`: _The relevant environment variables._
> - To Deploy: _Deploy settings for the new function._
> - To Run: _How to run on GCP._

## Commands

See `project.json` for available Nx commands, which may include additional features not documented here.

## Functions

### `scheduledFirestoreExport`

This function is scheduled to run every Friday at 11:59 PM PDT. It exports specified Firestore collections to a Google Cloud Storage bucket.

- Trigger: Pub/Sub Schedule (`every friday 23:59`).
- Environment Variables:
  - `PROJECT_ID`: The project ID.
  - `OUTPUT_BUCKET`: The GCS bucket to write to.
- To Deploy: Execute `nvm use 18` then `yarn deploy:staging` or `yarn deploy:production`
- To Run: Can force run in the Google Cloud Scheduler.

### `exportSnoozeStates`

This function is scheduled to run every day at 8:00 AM UTC (Midnight PST.) It exports currently active snoozes into a Google Cloud Storage bucket.

- Trigger: Cloud Scheduler (`0 8 * * *`).
- Environment Variables:
  - `SNOOZE_OUTPUT_BUCKET`: The GCS bucket to write to.
- To Deploy: Execute `nvm use 18` then `yarn deploy:staging` or `yarn deploy:production`
- To Run: `curl -X POST "https://us-central1-<PROJECT_ID>.cloudfunctions.net/exportSnoozeStates?=" -H "Authorization: bearer $(gcloud auth print-identity-token)"`
